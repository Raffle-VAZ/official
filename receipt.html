<!DOCTYPE html>
<html>
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <input type="file" id="fileInput" accept="image/*,application/pdf" hidden>
    <button onclick="document.getElementById('fileInput').click()">Выбрать файл</button>
    <button id="sendBtn" disabled>Отправить чек в бота</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const fileInput = document.getElementById('fileInput');
        const sendBtn = document.getElementById('sendBtn');
        let selectedFile = null;

        // Выбор файла
        fileInput.addEventListener('change', function() {
            selectedFile = this.files[0];

            if (!selectedFile) return;

            // Проверки файла
            if (!['image/jpeg', 'image/png', 'application/pdf'].includes(selectedFile.type)) {
                tg.showAlert('❌ Только JPG, PNG или PDF!');
                return;
            }

            if (selectedFile.size > 5 * 1024 * 1024) {
                tg.showAlert('❌ Файл слишком большой! Макс. 5MB');
                return;
            }

            sendBtn.disabled = false;
        });

        // Отправка файла
        sendBtn.addEventListener('click', () => {
            if (!selectedFile) return;

            const reader = new FileReader();

            reader.onloadstart = () => {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Отправка...';
            };

            reader.onload = () => {
                // Отправляем raw base64 без префикса
                const base64Data = reader.result.split(',')[1];

                tg.sendData(JSON.stringify({
                    action: 'receipt_upload',
                    file_name: selectedFile.name,
                    file_type: selectedFile.type,
                    data: base64Data
                }));

                tg.showAlert('✅ Чек успешно отправлен!');
                sendBtn.textContent = 'Отправлено!';
                setTimeout(() => tg.close(), 1000);
            };

            reader.onerror = () => {
                tg.showAlert('❌ Ошибка при чтении файла');
                sendBtn.disabled = false;
                sendBtn.textContent = 'Отправить чек в бота';
            };

            reader.readAsDataURL(selectedFile);
        });
    </script>
</body>
</html>